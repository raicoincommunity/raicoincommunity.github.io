<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="description" content="" />
    <meta name="author" content="" />
    <title>Search the chain - Raicoin</title>
    <!-- Favicon-->
    <link rel="icon" type="image/png" href="assets/img/favicon.png" />
    <!-- Font Awesome icons (free version)-->
    <script src="js/fontawesome/v5.13.0/all.js"></script>
    <!-- Google fonts-->
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet" type="text/css" />
    <link href="https://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic" rel="stylesheet"
        type="text/css" />
    <!-- Core theme CSS (includes Bootstrap)-->
    <link href="css/styles.css" rel="stylesheet" />
</head>

<body id="page-top">
    <!-- Navigation-->
    <nav class="navbar navbar-expand-lg bg-secondary text-uppercase fixed-top" id="mainNav">
        <div class="container">
            <a class="navbar-brand js-scroll-trigger" href="./index.html">Raicoin</a>
            <button
                class="navbar-toggler navbar-toggler-right text-uppercase font-weight-bold bg-primary text-white rounded"
                type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive"
                aria-expanded="false" aria-label="Toggle navigation">
                Menu
                <i class="fas fa-bars"></i>
            </button>
            <div class="collapse navbar-collapse" id="navbarResponsive">
              <ul class="navbar-nav ml-auto">
                <li class="nav-item mx-0 mx-lg-1"><a class="nav-link py-3 px-0 px-lg-3 rounded js-scroll-trigger"
                        href="https://raiwallet.org/" target="_blank">Wallet</a></li>
                <li class="nav-item mx-0 mx-lg-1"><a class="nav-link py-3 px-0 px-lg-3 rounded js-scroll-trigger"
                        href="#explorer">Explorer</a></li>
                <li class="nav-item mx-0 mx-lg-1"><a class="nav-link py-3 px-0 px-lg-3 rounded js-scroll-trigger"
                        href="https://pancakeswap.info/token/0x64EF755D5A2627538CAA3Eb62ee07f96f9B608E4" target="_blank">Exchange</a></li>
                <li class="nav-item mx-0 mx-lg-1"><a class="nav-link py-3 px-0 px-lg-3 rounded js-scroll-trigger"
                        href="./index.html#resource">Resource</a></li>
                <li class="nav-item mx-0 mx-lg-1"><a class="nav-link py-3 px-0 px-lg-3 rounded js-scroll-trigger"
                        href="./index.html#software">Software</a></li>
                
                <li class="nav-item mx-0 mx-lg-1"><a class="nav-link py-3 px-0 px-lg-3 rounded js-scroll-trigger"
                        href="nodes.html">Nodes</a></li>
              </ul>
            </div>
        </div>
    </nav>
    <!-- Explorer Section-->
    <section class="page-section portfolio" id="explorer">
        <div class="container">
            <form class="my-5" action="explorer.html" method="GET">
                <div class="form-row">
                    <div class="col-md">
                        <input type="text" class="form-control form-control-lg" value="" id="search" placeholder="Enter account address or block hash" name="search">
                    </div>
                    <div class="col-auto mt-2 mt-md-0">
                        <button class="btn btn-primary btn-lg"><span>Search</span></button>
                    </div>
                </div>
            </form>
        </div>
        <div class="text-center" id="load">
            <div class="spinner-border" role="status">
                <span class="sr-only">Loading...</span>
            </div>
        </div>
        <div class="text-center">
          <p id="error" class="d-none"></p>            
        </div>
      <div class="container d-none" id="account-info">
            <h2>Account Info:</h2>
            <table class="table table-striped" >
              <tbody>
              </tbody>
            </table>
        </div>
        <div class="container d-none" id="block-info">
            <h2>Block Info:</h2>
            <table class="table table-striped">
              <tbody>
              </tbody>
            </table>
        </div>  
        
        <div class="container d-none" id="delegator-list">
          <h2>
            <span id="toggle-delegators">
              <i class="fas fa-minus-circle fa-xs"></i>
            </span>
            Top Delegators:
          </h2>
          <div class="text-center" id="load-delegator-list">
            <div class="spinner-border" role="status">
                <span class="sr-only">Loading delegator list...</span>
            </div>
          </div>
          <table class="table table-striped d-none" id="table-delegators">
            <thead>
              <tr>
                  <th scope="col">#</th>
                  <th scope="col">Account</th>
                  <th scope="col">Type</th>
                  <th scope="col">Weight</th>
              </tr>
            </thead>
            <tbody>
            </tbody>
          </table>
          <div class="text-center">
            <p id="error-delegator-list" class="d-none"></p>            
          </div>
        </div>

        <div class="container d-none" id="rewardables">
          <h2>
            <span id="toggle-rewardables">
              <i class="fas fa-minus-circle fa-xs"></i>
            </span>
            Pending Rewardables:
          </h2>
          <div class="text-center" id="load-rewardables">
            <div class="spinner-border" role="status">
                <span class="sr-only">Loading pending rewardables...</span>
            </div>
          </div>
          <table class="table table-striped d-none" id="table-rewardables">
            <thead>
              <tr>
                  <th scope="col">#</th>
                  <th scope="col">Source</th>
                  <th scope="col">Amount</th>
                  <th scope="col">Release Time</th>
              </tr>
            </thead>
            <tbody>
            </tbody>
          </table>
          <div class="text-center">
            <p id="error-rewardables" class="d-none"></p>            
          </div>
        </div>

      
    </section>

    <!-- Footer-->
    <footer class="footer text-center">
        <div class="container">
            <div class="row">
                <!-- Footer Social Icons-->
                <div class="col-lg-6 mb-5 mb-lg-0">
                    <h4 class="text-uppercase mb-4">Follow us</h4>
                    <a class="btn btn-outline-light btn-social mx-1" href="https://t.me/RaicoinOfficial"><i
                      class="fab fa-fw fa-telegram-plane"></i></a>
                    <a class="btn btn-outline-light btn-social mx-1" href="https://twitter.com/RaicoinC"><i
                            class="fab fa-fw fa-twitter"></i></a>
                    <a class="btn btn-outline-light btn-social mx-1" href="https://github.com/raicoincommunity"><i class="fab fa-fw fa-github"></i></a>
                    <a class="btn btn-outline-light btn-social mx-1" href="https://bitcointalk.org/index.php?topic=5188094.0"><i class="fab fa-fw fa-dribbble"></i></a>
          </div>
                <!-- Footer About Text-->
                <div class="col-lg-6">
                    <h4 class="text-uppercase mb-4">About</h4>
                    <p class="lead mb-0">
                        Raicoin is a  MIT licensed opensource project.
                    </p>
                </div>
            </div>
        </div>
    </footer>
    <!-- Copyright Section-->
    <div class="copyright py-4 text-center text-white">
        <div class="container"><small>Copyright Â© Raicoin Community 2020</small></div>
    </div>
    <!-- Scroll to Top Button (Only visible on small and extra-small screen sizes)-->
    <div class="scroll-to-top d-lg-none position-fixed">
        <a class="js-scroll-trigger d-block text-center text-white rounded" href="#page-top"><i
                class="fa fa-chevron-up"></i></a>
    </div>

    <!-- Bootstrap core JS-->
    <script src="js/jquery/3.5.1/jquery.min.js"></script>
    <script src="js/bootstrap/4.5.0/bootstrap.bundle.min.js"></script>
    <!-- Third party plugin JS-->
    <script src="js/jquery-easing/1.4.1/jquery.easing.min.js"></script>
    <!-- Core theme JS-->
    <script src="js/scripts.js"></script>
    <script src="js/util.js"></script>
    <script src="js/search.js"></script>
    <script>
        $(function(){

          var hasDelegators = false;
          $("#toggle-delegators").click(function(){
            if (!hasDelegators) return;
            $(this).children().toggleClass("fa-minus-circle fa-plus-circle");
            $("#table-delegators").toggleClass("d-none");
          });

          var hasRewardables = false;
          $("#toggle-rewardables").click(function(){
            if (!hasRewardables) return;
            $(this).children().toggleClass("fa-minus-circle fa-plus-circle");
            $("#table-rewardables").toggleClass("d-none");
          });

          var toDate = function(timestamp) {
            timestamp = parseInt(timestamp) * 1000;
            var offsetMs = (new Date()).getTimezoneOffset() * 60 * 1000;
            timestamp -= offsetMs;
            var dateLocal = new Date(timestamp);
            var iso = dateLocal.toISOString();
            return iso.slice(0, 19).replace("T", " ");
          }

          var row = function(key, value){
            return '<tr>' +
              '<td>' + key + '</td>' +
			        '<td style="word-break:break-all; word-wrap:break-all;">' + value + '</td>' +
              '</tr>';
          };

          var toLink = function(value){
            return '<a href="./explorer.html?search=' + value + '">' + value + '</a>';
          };

          var rowDelegator = function(data, id) {
            return '<tr>' +
              '<td>' + id + '</td>' +
              '<td style="word-break:break-all; word-wrap:break-all;">' + toLink(data['account']) + '</td>' +
              '<td>' + data['type'] + '</td>' +
              '<td>' + $.formatInt(data['weight_in_rai'].split(' ')[0].split('.')[0]) + ' RAI' + '</td>' +
              '</tr>';
          }


          var rowRewardable = function(data, id) {
            return '<tr>' +
              '<td>' + id + '</td>' +
              '<td style="word-break:break-all; word-wrap:break-all;">' + toLink(data['hash']) + '</td>' +
              '<td>' + data['amount_in_rai'] + '</td>' +
              '<td>' + toDate(data['valid_timestamp']) + '</td>' +
              '</tr>';
          }

          var parseDelegatorList = function(data) {
            $('#load-delegator-list').hide();

            if ('error' in data) {
              if (!unknownAccountType) {
                $('#error-delegator-list').text(data['error']).removeClass("d-none");
              }
              return;
            }

            if (parseInt(data['count']) === 0) {
              if (!unknownAccountType) {
                $('#error-delegator-list').text('No delegators yet').removeClass("d-none");
              }
              return;
            }

            if (unknownAccountType) {
              $('#delegator-list').removeClass("d-none");
            }

            $('#delegator-list table').removeClass("d-none");
            var tbody = $('#delegator-list tbody');
            for (var i = 0; i < data['list'].length; ++i) {
              tbody.append(rowDelegator(data['list'][i], i + 1));
            }
            hasDelegators = true;
          }

          var errorProcessDelegatorList = function() {
            if (unknownAccountType) return;
            $('#load-delegator-list').hide();
            $('#error-delegator-list').text("Error: failed to connect api server").removeClass("d-none");
          }

          var unknownAccountType = false;
          var requestDelegators = function(account) {
            $.ajax({
              type: "POST",
              url: api,
              data: JSON.stringify({ action: 'delegator_list', representative: account, count: '100' }),
              contentType: "application/json; charset=utf-8",
              dataType: "json",
              success: parseDelegatorList,
              failure: errorProcessDelegatorList
            });
          }

          var parseRewardables = function(data) {
            $('#load-rewardables').hide();

            if ('error' in data) {
              if (!unknownAccountType) {
                $('#error-rewardables').text(data['error']).removeClass("d-none");
              }
              return;
            }

            if (!data['rewardables']) {
              if (!unknownAccountType) {
                $('#error-rewardables').text('No pending rewardables yet').removeClass("d-none");
              }
              return;
            }

            if (unknownAccountType) {
              $('#rewardables').removeClass("d-none");
            }

            $('#rewardables table').removeClass("d-none");
            var tbody = $('#rewardables tbody');
            for (var i = 0; i < data['rewardables'].length; ++i) {
              tbody.append(rowRewardable(data['rewardables'][i], i + 1));
            }
            hasRewardables = true;
          }

          var errorProcessRewardables = function() {
            if (unknownAccountType) return;
            $('#load-rewardables').hide();
            $('#error-rewardables').text("Error: failed to connect api server").removeClass("d-none");
          }

          var requestRewardables = function(account) {
            $.ajax({
              type: "POST",
              url: api,
              data: JSON.stringify({ action: 'rewardables', account: account, count: '100' }),
              contentType: "application/json; charset=utf-8",
              dataType: "json",
              success: parseRewardables,
              failure: errorProcessRewardables
            });
          }

          var parseAccountInfo = function(data){
            $('#load').hide();
            if ('error' in data)
            {
              var error = data['error'];
              if (error === 'The account does not exist') {
                error = 'The account has no transactions yet';
                unknownAccountType = true;
                requestDelegators(search);
                requestRewardables(search);
              }
              $('#error').text(error).removeClass("d-none");
              return;
            }
            var head = data['head_block'];

            var tbody = $('#account-info tbody');
            tbody.append(row('Type', data['type']));
            tbody.append(row('Account', data['account']));
            tbody.append(row('Balance', $.formatBalance(head['balance'])));
            var height = parseInt(head['height']);
            tbody.append(row('Blocks', height + 1));
            tbody.append(row("Credit", head['credit']));
            var max_tx = parseInt(head['credit']) * 20;
            tbody.append(row('Daily Transactions Limit', head['counter'] + ' / ' + max_tx));
            tbody.append(row('Forks / Restricted', data['forks'] + ' / ' + data['restricted']));
            tbody.append(row('Latest Block', toLink(data['head'])));
            if ('representative' in head)
            {
              tbody.append(row('Representative', toLink(head['representative'])));
            }

            $('#account-info').removeClass('d-none');

            if (data['type'] === 'representative') {
              $('#delegator-list').removeClass('d-none');
              requestDelegators(data['account']);
              $('#rewardables').removeClass('d-none');
              requestRewardables(data['account']);
            }
          };

          var parseBlockInfo = function(data){
            $('#load').hide();
            if ('error' in data)
            {
              $('#error').text(data['error']).removeClass("d-none");
              return;
            }
            console.log(data);
            if (data['status'] != 'success')
            {
              $('#error').text('The block doesn\'t exist').removeClass("d-none");
              return;
            }
            var hash = $.getUrlParameter('search');
            var block = data['block'];
            var tbody = $('#block-info tbody');
            tbody.append(row('Hash', hash));
            tbody.append(row('Account', toLink(block['account'])));
            tbody.append(row('Height', block['height']));
            tbody.append(row('Opcode', block['opcode']));
            tbody.append(row('Amount', $.formatBalance(data['amount'])));
            tbody.append(row('Credit', block['credit']));
            tbody.append(row('Counter', block['counter']));
            tbody.append(row('Balance', $.formatBalance(block['balance'])));
            tbody.append(row('Timestamp', toDate(block['timestamp'])));
            if ('representative' in block)
            {
              tbody.append(row('Representative', toLink(block['representative'])));
            }
            tbody.append(row('Link', toLink(block['link'])));
            tbody.append(row('Previous', toLink(block['previous'])));
            tbody.append(row('Successor', toLink(data['successor'])));

            if ('extensions' in block)
            {
              var extensions_size = parseInt(block['extensions_length']);
              tbody.append(row('Extensions Size', extensions_size));
              if (extensions_size > 0)
              {
                $.each(block['extensions'], function(i,v){
                  tbody.append(row('Extensions.' + v['type'], v['value']));
                });
              }
            }

            tbody.append(row('Signature', block['signature']));

            $('#block-info').removeClass('d-none');
          };

          var errorProcess = function(errMsg){
            $('#load').hide();
            $('#error').text("Error: failed to connect api server").removeClass("d-none");
          };

          var search = $.getUrlParameter('search');
          var api = "https://rpc.raicoin.org";
          if ($.validateAddress(search))
          {
            $.ajax({
              type: "POST",
              url: api,
              // The key needs to match your method's input parameter (case-sensitive).
              data: JSON.stringify({ 'action': 'account_info', 'account': search }),
              contentType: "application/json; charset=utf-8",
              dataType: "json",
              success: parseAccountInfo,
              failure: errorProcess
            });
          }
          else if ($.validateBlockHash(search))
          {
            $.ajax({
              type: "POST",
              url: api,
              // The key needs to match your method's input parameter (case-sensitive).
              data: JSON.stringify({ 'action': 'block_query', 'hash': search }),
              contentType: "application/json; charset=utf-8",
              dataType: "json",
              success: parseBlockInfo,
              failure: errorProcess
            });
          }
          else
          {
            $('#load').hide();
            $('#error').text("Error: invalid account address or block hash").removeClass("d-none");
          }
      }); 
    </script>
</body>

</html>